---
import { Element } from 'astro-json-element';

//This componenet is a fork of https://github.com/iozcelik/SarissaPagination
export interface Props {
	url: string;
	total: string|number;
	current: string|number;
	start?: string|number;
	end?: string|number;
	middle?: string|number;
	link?: {};
	active?: {};
	disabled?: {};
	first?: {};
	before?: {};
	after?: {};
	last?: {};
	defaults?: boolean;
	commas?: boolean;
	collapse?: boolean;
	[attrs: string]: any;
}
const {
	url,
	total,
	current,
	start=2,
	end=2,
	middle=2,
	link,
	active,
	disabled,
	first,
	before,
	after,
	last,
	defaults=false,
	commas=true,
	collapse=true,
	...attrs
} = Astro.props as Props;

//astro-json-element defaults
const default_attrs = {
	tag: "div",
	style: defaults&&"display:flex;justify-content:center;align-items:center;gap:.25rem;",
	...attrs
};

const default_style = `cursor:pointer;position:relative;display:inline-flex;align-items:center;padding:.2rem.6rem;border-radius:.2rem;border: 1px solid #ccc;flex-wrap:nowrap;line-height:1.25rem;font-size:.875rem;font-weight:500;`;

const default_link = {
	tag: "a",
	style: defaults&&`${default_style}`,
	onmouseover: defaults&&"this.style.textDecoration='underline';",
	onmouseout: defaults&&"this.style.textDecoration='none';",
	...link
};

const default_active = {
	tag: "a",
	text: commas?addCommas(current):current.toString(),
	style: defaults&&`${default_style}border: 1px solid #ccc;color:#0EA5E9;`,
	onmouseover: defaults&&"this.style.textDecoration='underline';",
	onmouseout: defaults&&"this.style.textDecoration='none';",
	...active
};

const default_disabled = {
	tag: "a",
	text: defaults&&"...",
	style: defaults&&`${default_style}cursor:default;opacity:.25;`,
	...disabled
};

//Create array of pages to map over
var pages = Array.from({ length: +total }, (v, i) => i + 1).map((i) => {
  	let page = {
		number: i,
		active: +current == i,
		disable: isDisabled(i)
	};
	return page;
});

//Calculate pages to display
function isDisabled(i){
	if(+current == i) return false
	//Toggle collapsing
	if(!collapse) return false;
	//Calc End Pages
	if(i <= +start || i >= +total - (+end-1)) return false;
	//Calc Middle Pages
	if(Math.abs(i - +current) <= +middle) return false;
	return true;
}

function addCommas(num) {
    if (typeof num == 'number') return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    if (typeof num == 'string') return num.replace(/[^\d]/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    return "0"
}
---

<Element {...{...default_attrs}}>
	<slot name="first"/>
	{pages.map((page, i) => {
		const page_attrs = {
			text: commas?addCommas(page.number):page.number.toString(),
			href: `${url}/${page.number}`,
			...default_link
		};
		//Active
		if (page.active) return <Element {...default_active}/>
		//Disabled
		else if (page.number != 1 && page.disable && !pages[i-1].disable) return <Element {...default_disabled}/>
		//Firt link
		else if (!page.disable && page.number == 1) return <Element {...{...page_attrs, ...first}}/>
		//Link Before Active Link
		else if (!page.disable && page.number == +current - 1) return <Element {...{...page_attrs, ...before}}/>
		//Link After Active Link
		else if (!page.disable && page.number == +current + 1) return <Element {...{...page_attrs, ...after}}/>
		///Last link
		else if (!page.disable && page.number == +total) return <Element {...{...page_attrs, ...last}}/>
		//Links (default, first, last)
		else if (!page.disable) return <Element {...page_attrs}/>
	})}
	<slot />
</Element>
