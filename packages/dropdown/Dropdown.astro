---
import XElement from 'astro-xelement'
import * as themes from './themes.js'

const {
    details: Details,
    summary: Summary,
    button: Button
} = XElement

interface Props {
    is?: string;
    id: string;
    text?: string;
    value?: string;
    options?: {};
	open?: boolean;
    lock?: boolean;
    collapse?: boolean;
    theme?: string|{};
}

const {
    is="menu",
    id,
    text,
    value,
    options={},
	open=false,
    lock=false,
    collapse=true,
    theme={}
} = Astro.props as Props

interface Theme {
    container: {[attrs: string]: any};
    toggle: {[attrs: string]: any};
    content: {[attrs: string]: any};
    options: {[attrs: string]: any};
}

const {
    container,
    toggle,
    content,
    options: option_attrs
} = theme as Theme

let theme_object = {
    container: {
        id: id,
        value: value,
        ...container
    },
    toggle: {
        id: `${id}-toggle`,
        ...toggle
    },
    content: {
        id: `${id}-content`,
        ...content
    },
    options: {...option_attrs},
} as Theme

//Load theme if specified
if (typeof theme === "string" && {...themes}.hasOwnProperty(theme)) {
	let _theme:Theme = themes[theme]
	Object.entries(_theme).forEach(([key, value]) => {
		theme_object[key] = {...theme_object[key], ...value}
	})
}
---

<Details {...theme_object.container}>
	<slot name="first" />
    <Summary {...theme_object.toggle}
        define:vars={{
			open,
            collapse
        }}
        @mousedown:prevent={(e) => {
            //Stop double toggling on click/focus when the 'open' prop is true
            if (!open) e.target.focus()
        }}
        @click:prevent={(e) => {
            e.target.parentElement.toggleAttribute('open')
            //Reassign focus after toggle when the 'open' prop is true
            if (open) e.target.focus()
        }}
        @focus={(e) => {
            //Opens dropdown on focus when using tab navigation when 'open' prop is true 
            if (open) e.target.parentElement.open = true   
        }}
        @focusout={(e) => {
            //Collapse dropdown if it looses focus
			if (collapse && !e.target.nextElementSibling.contains(e.relatedTarget)) e.target.parentElement.removeAttribute('open')
        }}
    >
		<slot name="toggle-before" />
		{text}
		<slot name="toggle-after" />
    </Summary>
	<slot name="before">
    <XElement {...theme_object.content}
        @is={is}
        define:vars={{
			open,
            lock,
            collapse
        }}
        @do={(element) => {
            //Make all child elements inside the dropdown content element tab navigatable
            Array.from(element.children).forEach(child => { child.setAttribute("tabindex","0") });
        }}
        @focusout={(e) => {
            //This took me three days to write idk how to explain it
            if (collapse && !e.target.parentElement.contains(e.relatedTarget)) {
                if (lock) {
                    if (e.relatedTarget) e.relatedTarget.focus()
                    else if (!open) e.target.parentElement.parentElement.open = true;
                    e.target.parentElement.previousElementSibling.focus()
                } else e.target.parentElement.parentElement.removeAttribute('open');
            }
        }}
    >
        <slot name="content-before" />
        {Object.entries(options).map(([k,v], i) => {
            return  <Button
                        {...theme_object.options}
                        define:vars={{
                            k,
                            v
                        }}
                        @click={(e) => {
							//Set the value of the dropdown and dropdown toggle to option value
                            e.path[2].value = v;
                            e.path[1].previousElementSibling.value = v;
							//Change the dropdown toggle textContent to match name of option
                            e.path[1].previousElementSibling.textContent = k;
							//Close dropdown
                            e.path[2].removeAttribute('open');
                        }}
                    >
                        {k}
                    </Button>
        })}
        <slot />
    </XElement>
	<slot name="last" />
</Details>
